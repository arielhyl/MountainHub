<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MountainHub Taiwan</title>
    <!-- ÂºïÂÖ• JSZip Áî®ÊñºÂåØÂá∫Â§öÂÄã CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --bg: #ffffff;
            --text: #1a1a1a;
            --secondary: #717171;
            --accent: #f5f5f5;
            --border: #eeeeee;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            margin: 0; background: var(--bg); color: var(--text); 
            overflow-x: hidden;
        }

        .app-container { max-width: 500px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; }
        .page { flex: 1; padding: 30px 20px 120px 20px; display: none; }
        .page.active { display: block; }

        .header-wrap { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; }
        .backup-icons { display: flex; gap: 15px; padding-top: 5px; }
        .icon-btn { cursor: pointer; color: var(--secondary); transition: color 0.2s; position: relative; }
        .icon-btn:hover { color: var(--text); }

        h1 { font-size: 20px; font-weight: 600; text-transform: uppercase; margin: 0; letter-spacing: 1px; }
        h2 { font-size: 14px; color: var(--text); margin: 20px 0 10px 0; font-weight: 600; border-left: 3px solid #000; padding-left: 8px; }

        nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top: 0.5px solid var(--border);
            display: flex; justify-content: space-around;
            padding: 12px 0 34px 0;
            z-index: 100;
        }
        .nav-item { cursor: pointer; text-align: center; color: var(--secondary); transition: 0.2s; flex: 1; }
        .nav-item.active { color: var(--text); font-weight: bold; }
        .nav-icon { font-size: 20px; margin-bottom: 4px; display: block; }
        .nav-text { font-size: 10px; text-transform: uppercase; }

        .stats-hero { padding: 40px 0; text-align: center; cursor: pointer; }
        .progress-circle-text { font-size: 48px; font-weight: 200; margin: 0; }
        .progress-bar-bg { width: 100%; height: 2px; background: var(--accent); margin-top: 15px; position: relative; }
        .progress-bar-fill { height: 100%; background: #000; width: 0%; transition: width 0.8s ease; }
        
        .search-box { margin-bottom: 20px; }
        .search-box input { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 0; font-size: 14px; }

        .peak-item { border-bottom: 0.5px solid var(--border); padding: 15px 0; cursor: pointer; }
        .peak-main { display: flex; justify-content: space-between; align-items: center; }
        .peak-title { font-size: 15px; }
        .peak-meta { font-size: 11px; color: var(--secondary); }
        .peak-details { display: none; padding: 15px 0; font-size: 13px; color: var(--secondary); line-height: 1.8; }
        .peak-details.open { display: block; }

        .done-action-box { display: flex; gap: 8px; margin-top: 10px; }
        .date-input { border: 1px solid var(--border); padding: 8px; font-size: 12px; flex: 1; }
        .btn-done { background: #000; color: #fff; border: none; padding: 12px; font-size: 12px; cursor: pointer; flex: 2; }
        .btn-done.is-completed { background: var(--accent); color: var(--secondary); }

        .input-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 24px; }
        .input-group input, .input-group select { border: 1px solid var(--border); padding: 12px; font-size: 14px; border-radius: 0; width: 100%; background: #fff; }
        .input-group button { background: #000; color: #fff; border: none; padding: 14px; font-size: 13px; cursor: pointer; }

        .weight-card { background: #000; color: #fff; padding: 30px; text-align: center; margin-bottom: 24px; }
        .weight-card small { font-size: 10px; opacity: 0.6; display: block; margin-bottom: 8px; }
        .weight-card span { font-size: 42px; font-weight: 200; }

        .list-row { display: flex; align-items: flex-start; justify-content: space-between; padding: 16px 0; border-bottom: 0.5px solid var(--border); font-size: 14px; }
        .log-date { font-size: 11px; color: var(--secondary); margin-bottom: 6px; }
        .log-tag { font-size: 10px; background: var(--accent); padding: 2px 6px; margin-right: 5px; text-transform: uppercase; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.98); z-index: 200; padding: 40px 20px; overflow-y: auto; }
        .modal.active { display: block; }
        .close-modal { position: absolute; top: 20px; right: 20px; font-size: 30px; cursor: pointer; color: var(--secondary); }
    </style>
</head>
<body>

<div class="app-container">
    <!-- È¶ñÈ†Å -->
    <section id="page-home" class="page active">
        <div class="header-wrap">
            <h1>MountainHub</h1>
            <div class="backup-icons">
                <div class="icon-btn" onclick="exportData()" title="ÂåØÂá∫ CSV (ZIP)">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                </div>
                <label class="icon-btn" title="ÂåØÂÖ• JSON">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    <input type="file" id="import-file" style="display:none" onchange="importData(event)">
                </label>
            </div>
        </div>
        
        <div class="stats-hero" onclick="showCompletedList()">
            <p class="progress-circle-text" id="total-done-count">0</p>
            <p style="font-size: 12px; color: var(--secondary); margin-top: -5px; letter-spacing: 1px;">COMPLETED PEAKS / 100</p>
            <div class="progress-bar-bg"><div class="progress-bar-fill" id="main-progress-bar"></div></div>
            <p style="font-size: 10px; color: var(--secondary); margin-top: 15px;">ÈªûÊìäÊü•ÁúãÂÆåÁôªÁ¥ÄÈåÑ</p>
        </div>
    </section>

    <!-- ÁôæÂ≤≥ÂàóË°®È†Å -->
    <section id="page-peaks" class="page">
        <h1>Peaks List</h1>
        <div class="search-box">
            <input type="text" id="peak-search" placeholder="ÊêúÂ∞ãÂ±±Âêç„ÄÅÂ±±Á≥ªÊàñÁ≠âÁ¥ö..." oninput="renderPeaks()">
        </div>
        <div id="peaks-container"></div>
    </section>

    <!-- Ë£ùÂÇôÈ†Å -->
    <section id="page-gear" class="page">
        <h1>Lightpack</h1>
        <div class="weight-card">
            <small>BASE WEIGHT (KG)</small>
            <span id="base-weight-display">0.00</span>
        </div>
        <div class="input-group">
            <select id="gear-category">
                <option value="ÁÇäÂÖ∑Á≥ªÁµ±">ÁÇäÂÖ∑Á≥ªÁµ±</option>
                <option value="ÈõªÂ≠êÁ≥ªÁµ±">ÈõªÂ≠êÁ≥ªÁµ±</option>
                <option value="ËÉåË≤†Á≥ªÁµ±">ËÉåË≤†Á≥ªÁµ±</option>
                <option value="Áù°Áú†Á≥ªÁµ±">Áù°Áú†Á≥ªÁµ±</option>
                <option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option>
            </select>
            <input type="text" id="gear-name" placeholder="ÂìÅÂêç">
            <input type="number" id="gear-weight" placeholder="ÈáçÈáè (g)">
            <button onclick="addGear()">ADD TO INVENTORY</button>
        </div>
        <div id="gear-container"></div>
    </section>

    <!-- Ë®ìÁ∑¥È†Å -->
    <section id="page-training" class="page">
        <h1>Training Log</h1>
        <div class="input-group">
            <input type="date" id="train-date">
            <select id="train-type" onchange="toggleTrainOther()">
                <option value="Áà¨Âù°">Áà¨Âù°</option>
                <option value="ËÇåÂäõ">ËÇåÂäõ</option>
                <option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ...</option>
            </select>
            <input type="text" id="train-desc" placeholder="Ëº∏ÂÖ•Ë®ìÁ∑¥È†ÖÁõÆÊèèËø∞" style="display:none;">
            <input type="text" id="train-weight" placeholder="Ë≤†Èáç (kg) ÊàñËº∏ÂÖ• NA">
            <button onclick="addTrain()">ADD ENTRY</button>
        </div>
        <div id="training-container"></div>
    </section>
</div>

<nav>
    <div class="nav-item active" onclick="navTo('home')"><span class="nav-icon">‚óã</span><span class="nav-text">Home</span></div>
    <div class="nav-item" onclick="navTo('peaks')"><span class="nav-icon">‚ñ≥</span><span class="nav-text">Peaks</span></div>
    <div class="nav-item" onclick="navTo('gear')"><span class="nav-icon">‚ñ°</span><span class="nav-text">Gear</span></div>
    <div class="nav-item" onclick="navTo('training')"><span class="nav-icon">‚óá</span><span class="nav-text">Train</span></div>
</nav>

<div id="modal-completed" class="modal">
    <div class="close-modal" onclick="closeModal()">√ó</div>
    <h1>ÂÆåÁôªÊ∏ÖÂñÆ</h1>
    <div id="completed-list-content"></div>
</div>

<script>
    const PEAKS_DATA = [
        {id:1, name:"ÁéâÂ±±‰∏ªÂ≥∞", height:3952, grade:"A", range:"ÁéâÂ±±", hut:"ÊéíÈõ≤Â±±Ëéä", permit:"ÂÖ•Âúí+ÂÖ•Â±±", transport:"ÂòâÁæ©ËΩâÊé•ÈßÅ"},
        {id:2, name:"Èõ™Â±±‰∏ªÂ≥∞", height:3886, grade:"A", range:"Èõ™Â±±", hut:"‰∏âÂÖ≠‰πùÂ±±Ëéä", permit:"ÂÖ•Âúí", transport:"Ê≠¶ÈôµËæ≤Â†¥"},
        {id:3, name:"ÁßÄÂßëÂ∑íÂ±±", height:3825, grade:"B", range:"‰∏≠Â§ÆÂ±±ËÑà", hut:"ÁôΩÊ¥ãÈáëÁ§¶", permit:"ÂÖ•Âúí+ÂÖ•Â±±", transport:"Êù±Âüî"},
        {id:4, name:"È¶¨ÂçöÊãâÊñØÂ±±", height:3785, grade:"C", range:"‰∏≠Â§ÆÂ±±ËÑà", hut:"È¶¨ÂâçÊ±†", permit:"ÂÖ•Âúí+ÂÖ•Â±±", transport:"Êù±Âüî"},
        {id:5, name:"ÂçóÊπñÂ§ßÂ±±", height:3742, grade:"B", range:"‰∏≠Â§ÆÂ±±ËÑà", hut:"ÂçóÊπñÂ±±Â±ã", permit:"ÂÖ•Âúí", transport:"ÊÄùÊ∫ê"},
        {id:6, name:"Êù±Â±±", height:3704, grade:"B", range:"ÁéâÂ±±", hut:"ÊéíÈõ≤Â±±Ëéä", permit:"ÂÖ•Âúí+ÂÖ•Â±±", transport:"ÂòâÁæ©"},
        {id:7, name:"‰∏≠Â§ÆÂ∞ñÂ±±", height:3703, grade:"C", range:"‰∏≠Â§ÆÂ±±ËÑà", hut:"‰∏≠Â§ÆÂ∞ñÊ∫™Êú®Â±ã", permit:"ÂÖ•Âúí", transport:"ÊÄùÊ∫ê"},
        {id:8, name:"Èõ™Â±±ÂåóÂ≥∞", height:3703, grade:"B", range:"Èõ™Â±±", hut:"Èõ™ÂåóÂ±±Â±ã", permit:"ÂÖ•Âúí", transport:"Ê≠¶Èôµ"},
        {id:9, name:"Â§ßÈóúÂ±±", height:3668, grade:"A", range:"ÂçóÊ©´", hut:"Â∫´ÂìàË´æÊñØÂ±±Â±ã", permit:"ÂÖ•Â±±", transport:"ÂçóÊ©´"},
        {id:10, name:"È¶¨Âà©Âä†ÂçóÂ±±", height:3546, grade:"C", range:"‰∏≠Â§ÆÂ±±ËÑà", hut:"È¶¨Âà©Âä†ÂçóÂ±±Â±ã", permit:"ÂÖ•Âúí+ÂÖ•Â±±", transport:"Êù±Âüî"},
        {id:11, name:"ÂçóÊπñÂåóÂ±±", height:3536, grade:"B", range:"‰∏≠Â§ÆÂ±±ËÑà", hut:"ÂçóÊπñÂ±±Â±ã", permit:"ÂÖ•Â±±", transport:"ÊÄùÊ∫ê"},
        {id:12, name:"Â§ßÈú∏Â∞ñÂ±±", height:3492, grade:"B", range:"Èõ™Â±±", hut:"‰πù‰πùÂ±±Ëéä", permit:"ÂÖ•Âúí", transport:"ËßÄÈúß"},
        {id:13, name:"ÂçóÈ†≠Â±±", height:3449, grade:"C", range:"‰∏≠Â§ÆÂ±±ËÑà", hut:"ÂçóÊπñÂ±±Â±ã", permit:"ÂÖ•Â±±", transport:"ÊÄùÊ∫ê"},
        {id:14, name:"ÂìÅÁî∞Â±±", height:3524, grade:"B", range:"Ê≠¶Èôµ‰∏âÂ∞ñ", hut:"Êñ∞ÈÅîÂ±±Â±ã", permit:"ÂÖ•Âúí", transport:"Ê≠¶Èôµ"},
        {id:15, name:"Â§ßÈõ™Â±±", height:3530, grade:"C", range:"Èõ™Â±±", hut:"Áø†Ê±†Â±±Â±ã", permit:"ÂÖ•Âúí", transport:"Ê≠¶Èôµ"},
        {id:16, name:"Â•áËêä‰∏ªÂ≥∞", height:3560, grade:"B", range:"Â•áËêä", hut:"Â•áËêäÂ±±Â±ã", permit:"ÂÖ•Â±±", transport:"ÂêàÊ≠°"},
        {id:17, name:"Â•áËêäÂåóÂ≥∞", height:3607, grade:"B", range:"Â•áËêä", hut:"Â•áËêäÂ±±Â±ã", permit:"ÂÖ•Â±±", transport:"ÂêàÊ≠°"},
        {id:18, name:"ÂêëÈôΩÂ±±", height:3602, grade:"A", range:"Âçó‰∫åÊÆµ", hut:"ÂòâÊòéÊπñÂ±±Â±ã", permit:"ÂÖ•Â±±", transport:"ÂêëÈôΩ"},
        {id:19, name:"Â§ßÊ∞¥Á™üÂ±±", height:3642, grade:"B", range:"Âçó‰∫åÊÆµ", hut:"Â§ßÊ∞¥Á™üÂ±±Â±ã", permit:"ÂÖ•Âúí+ÂÖ•Â±±", transport:"Êù±Âüî"},
        {id:20, name:"ÂêàÊ≠°ÂåóÂ≥∞", height:3422, grade:"A", range:"ÂêàÊ≠°", hut:"ÁÑ°(ÂñÆÊîª)", permit:"ÂÖç", transport:"Âè∞14Áî≤"},
        {id:21, name:"ÂêàÊ≠°‰∏ªÂ≥∞", height:3417, grade:"A", range:"ÂêàÊ≠°", hut:"ÁÑ°(ÂñÆÊîª)", permit:"ÂÖç", transport:"Âè∞14Áî≤"},
        {id:22, name:"ÂêàÊ≠°Êù±Â≥∞", height:3421, grade:"A", range:"ÂêàÊ≠°", hut:"ÁÑ°(ÂñÆÊîª)", permit:"ÂÖç", transport:"Âè∞14Áî≤"},
        {id:23, name:"Áü≥ÈñÄÂ±±", height:3237, grade:"A", range:"ÂêàÊ≠°", hut:"ÁÑ°(ÂñÆÊîª)", permit:"ÂÖç", transport:"Âè∞14Áî≤"},
        {id:24, name:"ÂêàÊ≠°Ë•øÂ≥∞", height:3145, grade:"B", range:"ÂêàÊ≠°", hut:"ÁÑ°(ÂñÆÊîª)", permit:"ÂÖç", transport:"Âè∞14Áî≤"},
        {id:25, name:"ÂåóÂ§ßÊ≠¶Â±±", height:3092, grade:"B", range:"ÂçóÁ´Ø", hut:"Ê™úË∞∑Â±±Ëéä", permit:"ÂÖ•Â±±", transport:"Ê≥∞Ê≠¶"},
        {id:85, name:"Èõ™Â±±Êù±Â≥∞", height:3201, grade:"A", range:"Èõ™Â±±", hut:"‰∏ÉÂç°Â±±Ëéä", permit:"ÂÖ•Âúí", transport:"Ê≠¶Èôµ"},
        {id:88, name:"ÈÉ°Â§ßÂ±±", height:3265, grade:"A", range:"ÁéâÂ±±Ë•øÈÉ®", hut:"ÁÑ°", permit:"ÂÖç", transport:"ÈÉ°Â§ßÊûóÈÅì"},
        {id:100, name:"Áü≥ÈñÄÂ±±", height:3237, grade:"A", range:"ÂêàÊ≠°", hut:"ÁÑ°", permit:"ÂÖç", transport:"Âè∞14Áî≤"}
        // (ÁúÅÁï•ÈÉ®ÂàÜÁôæÂ≤≥‰ª•Á∂≠ÊåÅÁ≤æÁ∞°ÔºåÂØ¶ÈöõÈÅã‰ΩúÂª∫Ë≠∞ÂåÖÂê´ÂÆåÊï¥ÂàóË°®)
    ];

    let state = {
        completed: JSON.parse(localStorage.getItem('mh-completed')) || {},
        gears: JSON.parse(localStorage.getItem('mh-gears')) || [],
        logs: JSON.parse(localStorage.getItem('mh-train-logs')) || []
    };

    function save() {
        localStorage.setItem('mh-completed', JSON.stringify(state.completed));
        localStorage.setItem('mh-gears', JSON.stringify(state.gears));
        localStorage.setItem('mh-train-logs', JSON.stringify(state.logs));
        updateUI();
    }

    // ÂåØÂá∫ CSV (ZIP ÂåÖÂê´‰∏âÂÄã CSV)
    async function exportData() {
        const zip = new JSZip();

        // 1. ÁôæÂ≤≥ CSV
        let peaksCsv = "ID,Name,CompletionDate\n";
        Object.entries(state.completed).forEach(([id, date]) => {
            const p = PEAKS_DATA.find(x => x.id == id);
            peaksCsv += `${id},"${p ? p.name : 'Unknown'}",${date}\n`;
        });
        zip.file("peaks_completion.csv", "\uFEFF" + peaksCsv);

        // 2. Ë£ùÂÇô CSV
        let gearsCsv = "Category,Name,Weight(g)\n";
        state.gears.forEach(g => {
            gearsCsv += `"${g.category}","${g.name}",${g.weight}\n`;
        });
        zip.file("gears_inventory.csv", "\uFEFF" + gearsCsv);

        // 3. Ë®ìÁ∑¥ CSV
        let trainingCsv = "Date,Type,Description,Load(kg)\n";
        state.logs.forEach(l => {
            trainingCsv += `${l.date},"${l.type}","${l.desc || ''}","${l.weight || 'NA'}"\n`;
        });
        zip.file("training_logs.csv", "\uFEFF" + trainingCsv);

        const content = await zip.generateAsync({type:"blob"});
        const url = URL.createObjectURL(content);
        const a = document.createElement('a');
        a.href = url;
        a.download = `MountainHub_Backup_${new Date().toISOString().split('T')[0]}.zip`;
        a.click();
    }

    // ÂåØÂÖ• JSON (ÁµêÊßãËºÉË§áÈõúÔºåÂª∫Ë≠∞‰ªçÁî® JSON ‰øùÊåÅË≥áÊñô‰∏ÄËá¥)
    function importData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const imported = JSON.parse(e.target.result);
                if(confirm("ÂåØÂÖ•ÊúÉË¶ÜËìãÁèæÊúâË≥áÊñôÔºåÁ¢∫ÂÆöÂóéÔºü")) {
                    state = imported;
                    save();
                    location.reload();
                }
            } catch (err) { alert("ÁÑ°ÊïàÁöÑÊ™îÊ°àÊ†ºÂºè„ÄÇ"); }
        };
        reader.readAsText(file);
    }

    function navTo(page) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(`page-${page}`).classList.add('active');
        const navIdx = {home:0, peaks:1, gear:2, training:3}[page];
        document.querySelectorAll('.nav-item')[navIdx].classList.add('active');
    }

    // ÁôæÂ≤≥Ê∏≤Êüì
    function renderPeaks() {
        const query = document.getElementById('peak-search').value.toLowerCase();
        const container = document.getElementById('peaks-container');
        const filtered = PEAKS_DATA.filter(p => p.name.includes(query) || p.range.includes(query) || p.grade.toLowerCase().includes(query));

        container.innerHTML = filtered.map(p => `
            <div class="peak-item" onclick="togglePeak(${p.id})">
                <div class="peak-main">
                    <span class="peak-title">${p.id.toString().padStart(3, '0')} ${p.name} (${p.height}m) ${state.completed[p.id] ? '‚úì' : ''}</span>
                    <span class="peak-meta">${p.grade}Á¥ö | ${p.range}</span>
                </div>
                <div id="peak-detail-${p.id}" class="peak-details">
                    <p>üõñ Â±±Â±ãÔºö${p.hut}</p>
                    <p>üìã Ë≠â‰ª∂Ôºö${p.permit}</p>
                    <p>üöå ‰∫§ÈÄöÔºö${p.transport}</p>
                    <div class="done-action-box" onclick="event.stopPropagation()">
                        <input type="date" id="date-pick-${p.id}" class="date-input" value="${state.completed[p.id] || new Date().toISOString().split('T')[0]}">
                        <button class="btn-done ${state.completed[p.id] ? 'is-completed' : ''}" onclick="toggleComplete(${p.id})">
                            ${state.completed[p.id] ? 'Êõ¥Êñ∞Êó•Êúü' : 'Ê®ôË®òÂÆåÁôª'}
                        </button>
                        ${state.completed[p.id] ? `<button class="btn-done" style="flex:1; background:#717171" onclick="deleteComplete(${p.id})">Âà™Èô§</button>` : ''}
                    </div>
                </div>
            </div>
        `).join('');
    }

    function togglePeak(id) {
        const el = document.getElementById(`peak-detail-${id}`);
        const isOpen = el.classList.contains('open');
        document.querySelectorAll('.peak-details').forEach(d => d.classList.remove('open'));
        if(!isOpen) el.classList.add('open');
    }

    function toggleComplete(id) {
        const dateValue = document.getElementById(`date-pick-${id}`).value;
        state.completed[id] = dateValue;
        save();
        renderPeaks();
    }

    function deleteComplete(id) {
        if(confirm("Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§ÂÆåÁôªÁ¥ÄÈåÑÂóéÔºü")) {
            delete state.completed[id];
            save();
            renderPeaks();
        }
    }

    // Ë£ùÂÇôÁÆ°ÁêÜ
    function addGear() {
        const category = document.getElementById('gear-category').value;
        const name = document.getElementById('gear-name').value;
        const weight = parseInt(document.getElementById('gear-weight').value);
        if(!name || isNaN(weight)) return;
        state.gears.push({ id: Date.now(), category, name, weight });
        document.getElementById('gear-name').value = '';
        document.getElementById('gear-weight').value = '';
        save();
        renderGears();
    }

    function deleteGear(id) {
        state.gears = state.gears.filter(g => g.id !== id);
        save();
        renderGears();
    }

    function renderGears() {
        const container = document.getElementById('gear-container');
        const categories = ["ÁÇäÂÖ∑Á≥ªÁµ±", "ÈõªÂ≠êÁ≥ªÁµ±", "ËÉåË≤†Á≥ªÁµ±", "Áù°Áú†Á≥ªÁµ±", "ÂÖ∂‰ªñ"];
        let html = '';
        categories.forEach(cat => {
            const items = state.gears.filter(g => g.category === cat);
            if(items.length > 0) {
                html += `<h2>${cat}</h2>`;
                items.forEach(g => {
                    html += `<div class="list-row"><div>${g.name} (${g.weight}g)</div><span onclick="deleteGear(${g.id})" style="color:#ccc; cursor:pointer;">√ó</span></div>`;
                });
            }
        });
        container.innerHTML = html || "<p style='color:#717171; font-size:13px;'>Â∞öÊú™Êñ∞Â¢ûË£ùÂÇô„ÄÇ</p>";
        calcWeight();
    }

    function calcWeight() {
        let total = state.gears.reduce((sum, g) => sum + g.weight, 0);
        document.getElementById('base-weight-display').innerText = (total / 1000).toFixed(2);
    }

    // Ë®ìÁ∑¥ÁÆ°ÁêÜ
    function toggleTrainOther() {
        const type = document.getElementById('train-type').value;
        document.getElementById('train-desc').style.display = (type === "ÂÖ∂‰ªñ") ? "block" : "none";
    }

    function addTrain() {
        const date = document.getElementById('train-date').value;
        const type = document.getElementById('train-type').value;
        const desc = document.getElementById('train-desc').value;
        const weight = document.getElementById('train-weight').value || "NA";
        
        if(!date) return;
        state.logs.push({ 
            id: Date.now(), 
            date, 
            type, 
            desc: type === "ÂÖ∂‰ªñ" ? desc : "", 
            weight 
        });
        document.getElementById('train-desc').value = '';
        document.getElementById('train-weight').value = '';
        save();
        renderLogs();
    }

    function renderLogs() {
        const container = document.getElementById('training-container');
        const sorted = [...state.logs].sort((a,b) => b.date.localeCompare(a.date));
        container.innerHTML = sorted.map(l => `
            <div class="list-row">
                <div style="flex:1;">
                    <div class="log-date">${l.date}</div>
                    <div>
                        <span class="log-tag">${l.type}</span>
                        ${l.desc ? `<span style="font-size:14px;">${l.desc}</span>` : ''}
                        <span style="font-size:12px; color:var(--secondary); margin-left:10px;">L: ${l.weight}kg</span>
                    </div>
                </div>
                <span onclick="deleteLog(${l.id})" style="color:#ccc; font-size:22px; cursor:pointer;">√ó</span>
            </div>
        `).join('');
    }

    function deleteLog(id) {
        state.logs = state.logs.filter(l => l.id !== id);
        save();
        renderLogs();
    }

    function updateUI() {
        const count = Object.keys(state.completed).length;
        document.getElementById('total-done-count').innerText = count;
        document.getElementById('main-progress-bar').style.width = count + '%';
    }

    function showCompletedList() {
        const content = document.getElementById('completed-list-content');
        const entries = Object.entries(state.completed).sort((a,b) => b[1].localeCompare(a[1]));
        content.innerHTML = entries.length === 0 ? "<p style='text-align:center; padding:40px;'>ÁÑ°Á¥ÄÈåÑ</p>" :
            entries.map(([id, date]) => {
                const p = PEAKS_DATA.find(x => x.id == id);
                return `<div class="list-row"><strong>${p ? p.name : 'Êú™Áü•'}</strong> <span>${date}</span></div>`;
            }).join('');
        document.getElementById('modal-completed').classList.add('active');
    }

    function closeModal() {
        document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
    }

    window.onload = () => {
        document.getElementById('train-date').valueAsDate = new Date();
        renderPeaks();
        renderGears();
        renderLogs();
        updateUI();
    };
</script>

</body>
</html>

